name: Ubuntu Root VPS (Telegram Notify)

on:
  workflow_dispatch:

jobs:
  vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: ğŸ”„ Update system
      run: |
        sudo apt update -y
        sudo apt upgrade -y

    - name: ğŸ”§ Install packages
      run: |
        sudo apt install -y openssh-server curl wget unzip sudo util-linux openssl

    - name: ğŸ’¾ Setup SWAP (4GB)
      run: |
        sudo fallocate -l 4G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab

    - name: ğŸ“ Setup /mnt storage
      run: |
        sudo mkdir -p /mnt/workspace
        sudo chmod 777 /mnt/workspace
        df -h

    - name: ğŸ” Generate ROOT password
      run: |
        PASS=$(openssl rand -base64 12)
        echo "ROOT_PASS=$PASS" >> $GITHUB_ENV
        echo "ROOT_PASS=$PASS"

    - name: ğŸ‘‘ Enable ROOT SSH
      run: |
        echo "root:${ROOT_PASS}" | sudo chpasswd
        sudo sed -i 's/^#\?PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
        sudo sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
        sudo systemctl restart ssh

    - name: â˜ï¸ Install cloudflared
      run: |
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
        chmod +x cloudflared-linux-amd64
        sudo mv cloudflared-linux-amd64 /usr/local/bin/cloudflared

    - name: ğŸŒ Start Tunnel + Telegram Notify
      run: |
        echo "Starting Cloudflare Tunnel..."
        TUNNEL_OUTPUT=$(cloudflared tunnel --url tcp://localhost:22 --no-autoupdate 2>&1 | tee /tmp/tunnel.log)

        SSH_LINE=$(grep -oE 'tcp://[^ ]+' /tmp/tunnel.log | head -n 1)

        MESSAGE="
ğŸ”¥ *Ubuntu ROOT VPS Ready*

ğŸ‘¤ *User:* root
ğŸ”‘ *Password:* \`${ROOT_PASS}\`

ğŸŒ *SSH Address:*
\`${SSH_LINE}\`

ğŸ“ *Storage:* /mnt/workspace
â± *Auto Destroy:* 6 Hours
"

        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.TG_CHAT_ID }}" \
          -d parse_mode=Markdown \
          -d text="$MESSAGE"

        tail -f /dev/null
