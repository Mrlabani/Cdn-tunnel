name: Ubuntu Root VPS (Fixed & Stable)

on:
  workflow_dispatch:

jobs:
  vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Update system
      run: |
        sudo apt update -y
        sudo apt install -y openssh-server curl wget openssl

    - name: Setup storage
      run: |
        sudo mkdir -p /mnt/workspace
        sudo chmod 777 /mnt/workspace
        df -h

    - name: Generate ROOT password
      run: |
        PASS=$(openssl rand -hex 8)
        echo "ROOT_PASS=$PASS" >> $GITHUB_ENV
        echo "Generated password"

    - name: Enable ROOT SSH
      run: |
        echo "root:${ROOT_PASS}" | sudo chpasswd
        sudo sed -i 's/^#\?PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
        sudo sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
        sudo systemctl restart ssh

    - name: Install cloudflared
      run: |
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
        chmod +x cloudflared-linux-amd64
        sudo mv cloudflared-linux-amd64 /usr/local/bin/cloudflared

    - name: Start Cloudflare tunnel
      run: |
        cloudflared tunnel --url tcp://localhost:22 --no-autoupdate > cf.log 2>&1 &
        sleep 15
        URL=$(grep -oE 'tcp://[^ ]+' cf.log | head -n 1)
        if [ -z "$URL" ]; then
          echo "Tunnel failed"; cat cf.log; exit 1
        fi
        echo "SSH_URL=$URL" >> $GITHUB_ENV

    - name: Send Telegram notification
      run: |
        TEXT="ğŸ”¥ *Ubuntu ROOT VPS Ready*

ğŸ‘¤ User: root
ğŸ”‘ Password: \`${ROOT_PASS}\`

ğŸŒ SSH:
\`${SSH_URL}\`

ğŸ“ Storage: /mnt/workspace
â± Auto destroy: 6 hours"

        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.TG_CHAT_ID }}" \
          -d parse_mode=Markdown \
          -d text="$TEXT"

    - name: Keep VPS alive
      run: |
        echo "VPS running..."
        sleep 21600
