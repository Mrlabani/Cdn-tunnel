name: Manual Ubuntu VPS (ngrok)

on:
  workflow_dispatch:

jobs:
  vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Install base packages
      run: |
        sudo apt update
        sudo apt install -y openssh-server curl unzip jq tmux

    - name: Create SSH user
      run: |
        sudo useradd -m runner || true
        PASS=$(openssl rand -hex 8)
        echo "PASS=$PASS" >> $GITHUB_ENV
        echo "runner:$PASS" | sudo chpasswd
        sudo usermod -aG sudo runner
        sudo sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
        sudo sed -i 's/^#\?PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config
        sudo systemctl restart ssh

    - name: Install ngrok
      run: |
        curl -L https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz -o ngrok.tgz
        tar -xzf ngrok.tgz
        sudo mv ngrok /usr/local/bin/ngrok
        ngrok config add-authtoken ${{ secrets.NGROK_TOKEN }}

    - name: Start ngrok SSH
      run: |
        tmux new -d "ngrok tcp 22"
        sleep 10
        curl -s http://127.0.0.1:4040/api/tunnels > tunnels.json

    - name: Show SSH access
      run: |
        URL=$(jq -r '.tunnels[0].public_url' tunnels.json)
        HOST=$(echo $URL | sed 's|tcp://||' | cut -d: -f1)
        PORT=$(echo $URL | cut -d: -f3)
        echo ""
        echo "=============================="
        echo " SSH ACCESS"
        echo "=============================="
        echo "User     : runner"
        echo "Password : $PASS"
        echo "Host     : $HOST"
        echo "Port     : $PORT"
        echo ""
        echo "SSH COMMAND:"
        echo "ssh runner@$HOST -p $PORT"
        echo ""
        echo "AFTER LOGIN RUN:"
        echo "sudo -i"
        echo "=============================="

    - name: Keep VPS alive
      run: sleep 6h
