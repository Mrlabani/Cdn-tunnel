name: Manual VPS (ngrok SSH)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Install packages
      run: |
        sudo apt update
        sudo apt install -y openssh-server curl unzip jq tmux

    - name: Generate SSH password
      id: pass
      run: |
        PASS=$(openssl rand -base64 12)
        echo "PASS=$PASS" >> $GITHUB_ENV

    - name: Setup SSH
      run: |
        sudo useradd -m runner || true
        echo "runner:$PASS" | sudo chpasswd
        sudo sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
        sudo systemctl restart ssh

    - name: Install ngrok
      run: |
        curl -L https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz -o ngrok.tgz
        tar -xzf ngrok.tgz
        sudo mv ngrok /usr/local/bin/ngrok
        ngrok config add-authtoken ${{ secrets.NGROK_TOKEN }}

    - name: Start ngrok SSH
      run: |
        tmux new -d "ngrok tcp 22"
        sleep 10
        curl -s http://127.0.0.1:4040/api/tunnels > tunnels.json

    - name: Show SSH info
      run: |
        URL=$(jq -r '.tunnels[0].public_url' tunnels.json)
        echo ""
        echo "=============================="
        echo " SSH ACCESS READY"
        echo "=============================="
        echo "User: runner"
        echo "Password: $PASS"
        echo "Tunnel: $URL"
        echo ""
        echo "SSH COMMAND:"
        echo "ssh runner@$(echo $URL | sed 's|tcp://||' | cut -d: -f1) -p $(echo $URL | cut -d: -f3)"
        echo "=============================="

    - name: Keep VPS alive
      run: sleep 6h
